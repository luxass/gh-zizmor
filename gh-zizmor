#!/usr/bin/env bash
set -e

if ! type -p zizmor >/dev/null; then
  echo "Zizmor not found on the system" >&2
  echo "Please install zizmor: https://docs.zizmor.sh/installation/" >&2
  exit 1
fi

# handle --help/-h and --version flags directly
if [[ "$1" == "--help" || "$1" == "-h" || "$1" == "--version" ]]; then
  exec zizmor "$@"
fi

# check if lsp command is being used
if [[ "$1" == "lsp" ]]; then
  echo "For LSP functionality, please call 'zizmor lsp' directly" >&2
  exit 1
fi

# check if --gh-token flag is already provided
has_gh_token=false
for arg in "$@"; do
  if [[ "$arg" == --gh-token* ]]; then
    has_gh_token=true
    break
  fi
done

# check for completion related flags
for arg in "$@"; do
  if [[ "$arg" == "--generate-completion" || "$arg" == "--completion" || "$arg" == "--generate-shell-completion" ]]; then
    echo "For completion functionality, please call 'zizmor' with completion flags directly" >&2
    exit 1
  fi
done

GIT_REPOSITORY_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || true)

# if no --gh-token provided, get token and add it
if [[ "$has_gh_token" == "false" ]]; then
  TOKEN=$(gh auth token)

  if [ -z "$TOKEN" ]; then
    echo "Failed to retrieve GitHub token" >&2
    exit 1
  fi

  # if no arguments provided, use default directory
  if [ $# -eq 0 ]; then
    exec zizmor --gh-token="$TOKEN" "$GIT_REPOSITORY_ROOT/.github/workflows"
  else
    exec zizmor --gh-token="$TOKEN" "$@"
  fi
else
  # --gh-token already provided, pass through all arguments
  exec zizmor "$@"
fi
